# windows网络流量智能分析工具 - 项目需求文档

## 1. 项目概述

### 1.1 项目背景
在日常工作中产生对windows网络安全监控的需求。利用系统运维中产生大量的网络连接日志（JSONL格式），快速分析网络行为模式、识别异常连接、统计流量特征，为安全分析和运维决策提供支持。

### 1.2 项目目标
开发一个基于AI的智能分析工具，自动分析整理后的网络连接日志JSONL文件，生成结构化的分析报告，识别异常行为和潜在风险并给出安全建议。

### 1.3 适用场景
- 网络安全分析：检测异常连接、可疑IP/端口访问
- 系统运维监控：网络流量统计、进程网络行为分析
- 合规审计：网络访问记录分析、安全策略验证

---

## 2. 数据结构

### 2.1 JSONL文件格式
每行一个JSON对象，包含以下字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| timestamp | string | ISO 8601时间戳格式 |
| process | string | 进程完整路径 |
| command_line | string | 命令行（可能为空） |
| user | string | Windows用户名 |
| dest_ip | string | 目标IP地址（支持IPv4和IPv6） |
| dest_port | string | 目标端口号 |
| protocol | string | 网络协议（tcp/udp等） |
| domain | string | 目标域名（可能为空） |
| source | string | 来源标识（如 ip_only） |

### 2.2 示例数据
```json
{
  "timestamp": "2026-01-21T18:30:47.7755863+08:00",
  "process": "C:\\Windows\\System32\\svchost.exe",
  "command_line": "",
  "user": "NT AUTHORITY\\NETWORK SERVICE",
  "dest_ip": "fd31:a4da:aed3:0:0:0:0:1",
  "dest_port": "53",
  "protocol": "udp",
  "domain": "",
  "source": "ip_only"
}
```

---

## 3. 产品功能

### 3.1 核心功能

#### 3.1.1 文件解析
- 读取指定文件夹中的所有.jsonl文件
- 自动检测文件编码（UTF-8、GBK等）
- 支持小规模数据（< 10MB）完全加载到内存
- 数据格式验证和错误记录
- 错误日志

#### 3.1.2 基础统计分析
- **时间分析**：日志时间范围、时间分布（按小时、按日期）
- **连接统计**：总连接数、TCP/UDP连接占比
- **进程分析**：Top N活跃进程、进程连接数分布
- **用户分析**：连接用户分布、特权账户访问统计
- **网络地址分析**：
  - 目标IP去重统计
  - 内网/外网IP分类
  - 常见端口访问统计
  - 高频访问IP分析
- **域名分析**：访问域名统计（如有）

#### 3.1.3 AI驱动的深度分析
- **异常检测**：
  - 非常规端口访问（如非标准服务的端口）
  - 异常时间段的网络活动
  - 可疑的外网IP访问
- **安全风险评估**：
  - 已知恶意IP匹配（需要威胁情报库）
  - 特权进程的异常外网连接
  - 短时间内的异常大量连接
- **行为模式识别**：
  - 进程网络行为模式总结
  - 定时任务/周期性连接检测
  - P2P/点对点连接特征
- **关联分析**：
  - 进程-IP-端口的关联关系
  - 用户-进程的网络访问模式

#### 3.1.4 报告生成
自动生成Markdown格式报告，包含：
- **执行摘要**：关键发现、风险等级概览
- **基础统计**：数字化的统计指标
- **时间分布分析**：连接时间可视化建议
- **进程行为分析**：各进程网络活动详情
- **IP访问分析**：Top IP访问列表、风险IP标注
- **安全发现**：AI识别的异常和潜在风险
- **优化建议**：安全加固建议、监控建议
- **数据附录**：详细统计表格

### 3.2 扩展功能（v2.0规划）
- [x] 支持威胁情报库API集成
- 多日志文件对比分析
- 实时流式分析
- 历史趋势对比
- 告警规则配置
- Web可视化界面

---

## 4. 非功能性需求

### 4.1 性能要求
- 单文件分析时间：< 30秒（针对10MB以内文件）
- 内存占用：< 500MB

### 4.2 易用性要求
- 提供清晰的命令行界面
- 支持配置文件管理
- 错误提示清晰明确
- 报告格式易于阅读

### 4.3 可扩展性要求
- 支持多种国产大模型API（智谱AI、阿里云Qwen等）
- 可自定义分析规则
- 支持添加威胁情报源

### 4.4 安全性要求
- 本地处理数据，不泄露敏感信息
- API Key安全存储
- 支持敏感字段脱敏（如进程路径中的用户名）

---

## 5. 技术方案

### 5.1 技术栈

| 组件 | 技术选型 | 说明 |
|------|----------|------|
| 开发语言 | Python 3.10+ | 生态成熟，数据分析库丰富 |
| JSONL处理 | jsonlines | 专门的JSONL处理库 |
| 数据分析 | pandas, numpy | 统计计算、数据聚合 |
| AI模型API | 智谱AI / 阿里云Qwen / OpenAI GPT | 支持多种AI模型，用户自由选择 |
| 报告生成 | markdown | Markdown格式生成 |
| 配置管理 | YAML / Python Config | 灵活的配置方案 |
| 日期处理 | python-dateutil | 时间解析和格式化 |
| IP地址处理 | ipaddress | IP地址解析和分类 |

### 5.2 架构设计

```
┌──────────────────────────────────────────────────────────────┐
│                    主程序 (main.py)                           │
└─────────────────────────┬────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│ FileScanner │   │ LogAnalyzer │   │  Reporter   │
│  文件扫描    │   │  日志分析    │   │  报告生成    │
└──────┬──────┘   └──────┬──────┘   └──────┬──────┘
       │                 │                 │
       ▼                 ▼                 │
┌──────────────────────────────────────────┐│
│           数据处理层                        ││
│  - JSONL解析                             ││
│  - 统计计算（连接数、IP分布等）           ││
│  - IP地址分类（内网/外网）                ││
│  - 时间聚合                               ││
└────────────────────┬─────────────────────┘│
                     │                     │
                     ▼                     │
┌──────────────────────────────────────────┐│
│            AI分析层                       ││
│  - 异常检测                             ││
│  - 安全风险评估                         ││
│  - 行为模式识别                         ││
│  - 生成分析结论                         ││
└────────────────────┬─────────────────────┘│
                     │                     │
                     ▼                     │
┌──────────────────────────────────────────┐│
│            AI API层                       ││
│  - 模型API调用封装                       ││
│  - 多供应商支持                          ││
│  - 提示词工程优化                        ││
└──────────────────────────────────────────┘│
                     │                     │
                     └─────────────────────┘
```

### 5.3 项目结构

```
jsonl-network-analyzer/
├── src/
│   ├── __init__.py
│   ├── main.py              # 程序入口
│   ├── config.py            # 配置管理
│   ├── file_scanner.py      # 文件扫描模块
│   ├── jsonl_parser.py      # JSONL解析模块
│   ├── log_analyzer.py      # 日志分析核心模块
│   ├── ai_client.py         # AI API客户端（支持多厂商）
│   ├── reporter.py          # 报告生成模块
│   └── utils.py             # 工具函数
│       ├── ip_utils.py      # IP地址处理
│       ├── time_utils.py    # 时间处理
│       └── stats.py         # 统计计算
├── data/                    # 输入目录
│   └── (放置.jsonl文件)
├── output/                  # 输出目录
│   └── (生成报告)
├── config/
│   ├── config.yaml          # 主配置文件
│   └── ai_providers.yaml    # AI服务商配置（包含威胁情报）
├── tests/                   # 测试用例
│   ├── test_parser.py
│   ├── test_analyzer.py
│   └── test_reporter.py
├── examples/                # 示例文件
│   ├── sample_data.jsonl
│   └── sample_report.md
├── requirements.txt         # 依赖清单
├── README.md               # 使用说明
└── setup.py                # 安装脚本（可选）
```

---

## 6. 功能优先级

### P0（核心功能，MVP）
- [x] JSONL文件解析
- [x] 基础统计（连接数、进程、IP、端口）
- [x] 时间分布分析
- [x] 简单报告生成

### P1（重要功能）
- [x] AI异常检测
- [x] IP分类（内网/外网）
- [x] 安全风险评估
- [x] 威胁情报集成

### P2（增强功能）
- [ ] 多文件分析
- [ ] 历史对比
- [ ] 告警规则
- [ ] Web界面

---

## 7. 交付物

### 7.1 代码交付
- 完整的源代码
- 单元测试（覆盖率 > 70%）
- 代码注释和文档

### 7.2 文档交付
- README.md - 使用说明
- 配置文件说明
- API文档（如需二次开发）

### 7.3 示例交付
- 示例网络日志JSONL文件
- 示例分析报告
- 常见使用场景说明

---

## 8. 使用示例

### 8.1 命令行使用
```bash
# 分析单个文件
python src/main.py --file data/net_2026-01-21.jsonl

# 分析文件夹下所有文件
python src/main.py --dir data/

# 指定输出目录
python src/main.py --dir data/ --output output/

# 使用特定AI模型
python src/main.py --dir data/ --model qwen

# 查看帮助
python src/main.py --help
```

### 8.2 配置文件示例
```yaml
# config/config.yaml
ai_provider: zhipu  # zhipu / qwen / kimi
api_key: YOUR_API_KEY
output_format: markdown  # markdown / html / json
analysis:
  detect_anomalies: true
  check_threat_intel: true
  include_time_distribution: true
risk_threshold: medium  # low / medium / high
```

---

## 9. 时间规划

| 阶段 | 任务 | 预计工作量 |
|------|------|-----------|
| 第1阶段 | 项目初始化、JSONL解析、基础统计 | 1-2天 |
| 第2阶段 | AI集成、异常检测、风险评估 | 2-3天 |
| 第3阶段 | 报告生成优化、威胁情报集成 | 1-2天 |
| 第4阶段 | 测试、文档编写、示例准备 | 1天 |

---

## 10. 风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| AI API不稳定 | 分析失败 | 支持多供应商切换，增加重试机制 |
| API调用超预算 | 成本超支 | 优化批处理策略，提供使用量监控 |
| 数据格式异常 | 解析失败 | 增强容错能力，详细错误提示 |
| 威胁情报API限流 | 风险检测不全 | 本地缓存，支持离线分析 |
| 敏感信息泄露 | 安全风险 | 本地处理，支持数据脱敏 |

---

## 11. 成功标准

- [ ] 能成功解析网络日志JSONL文件
- [ ] 基础统计分析准确完整
- [ ] AI分析结果有意义，能识别潜在风险
- [ ] 生成的报告结构清晰、易于理解
- [ ] 支持至少2种国产大模型API
- [ ] 核心功能有测试覆盖
- [ ] 文档完整，用户能独立使用
- [ ] 对net_2026-01-21.jsonl文件能生成有效分析报告

---

## 12. 数据分析维度详细设计

### 12.1 时间维度
- 日志起始时间和结束时间
- 连接按小时分布（识别高峰时段）
- 连接按日期分布（识别日周期）
- 是否存在夜间/非工作时间的异常连接

### 12.2 进程维度
- Top 10活跃进程
- 系统进程 vs 应用进程占比
- 特权进程（SYSTEM、NETWORK SERVICE）的外网访问
- 异常进程路径检测

### 12.3 IP维度
- 唯一IP数量
- IPv4 vs IPv6 分布
- 内网IP段识别（10.x.x.x, 192.168.x.x, 172.16-31.x.x, fd00::/8）
- 外网IP统计
- 高频访问IP（Top 20）
- 威胁情报库匹配

### 12.4 端口维度
- 常见端口访问统计（80, 443, 53, 22, 3389等）
- 非常规端口访问
- 高危端口访问（如445, 135, 139等）
- UDP端口 vs TCP端口

### 12.5 用户维度
- 连接发起用户分布
- 特权账户使用情况
- 用户-进程-IP的访问关系

---

---

## 13. 功能更新日志

### v1.2 (2026-01-23)
#### ✅ 新增功能
- **OpenAI GPT 集成**
  - 新增 OpenAI GPT 客户端支持
  - 支持所有 OpenAI 模型（GPT-4o、GPT-4 Turbo、GPT-3.5 Turbo 等）
  - 用户可在配置文件中自由指定任意 OpenAI 模型
  - 支持 OpenAI 兼容的第三方 API 服务

- **AI 提供商扩展**
  - 新增 `OpenAIClient` 类，遵循现有 AI 客户端架构
  - 在 `config/ai_providers.yaml` 中添加 OpenAI 配置
  - 命令行参数支持 `openai` 选项

- **模型选择灵活性**
  - 用户可通过修改 `ai_providers.yaml` 中的 `model` 字段切换模型
  - 支持 GPT-4o（默认）、gpt-4-turbo、gpt-3.5-turbo 等模型
  - API Base URL 可配置，支持自定义端点

#### 🔧 技术改进
- 扩展 `get_ai_client()` 工厂函数，新增 OpenAI 客户端映射
- 更新 `AIProvidersConfig` 默认配置，包含 OpenAI 配置
- 实现标准的 OpenAI API 调用接口

#### 📋 文档更新
- 更新技术栈表格，添加 OpenAI GPT 说明
- 更新 README.md，添加 OpenAI 配置和使用说明
- 更新 PRD 版本日志

*文档版本：v1.2*
*创建时间：2026-01-23*

### v1.1 (2026-01-22)
#### ✅ 新增功能
- **ThreatFox 威胁情报集成**
  - 集成 ThreatFox API 支持实时恶意 IP 查询
  - 批量查询优化，支持一次查询最多 100 个 IP
  - 自动过滤内网 IP，只查询外网 IP 地址
  - 威胁情报结果在报告中可视化展示
  - 支持威胁类型、首次发现时间、最后发现时间等信息
  - 提供恶意 IP 风险警告和详细信息

- **威胁情报配置管理**
  - 在 `config/ai_providers.yaml` 中添加 ThreatFox 配置
  - 支持 API Key 直接配置（用户需自行保护密钥安全）
  - 威胁情报功能可通过配置开关控制
  - 默认启用威胁情报检查

- **报告增强**
  - IP 访问分析中增加威胁情报标注
  - 新增"威胁情报发现"专门章节
  - 恶意 IP 列表显示威胁类型和发现时间
  - 高风险警告标识（🔴）

#### 🔧 技术改进
- 新增 `ThreatFoxClient` 类，遵循现有 AI 客户端架构
- 实现带重试机制的 API 调用
- 优雅处理 API 认证失败、网络异常等情况
- 扩展命令行参数支持 `threatfox` 模型选择
- 添加威胁情报查询的性能优化

#### 📋 文档更新
- 更新项目架构图（移除单独的 threat_intel.yaml）
- 更新功能优先级（威胁情报集成标记为已完成）
- 新增 ThreatFox 集成使用说明

*文档版本：v1.1*
*创建时间：2026-01-22*
*状态：已审核*
